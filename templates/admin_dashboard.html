{% extends 'base.html' %} 
{% block content %}
<div class="container my-4">
  <!-- Admin Welcome Section -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="mb-3 text-primary">Admin Dashboard</h2>
      <p class="lead text-muted">
        Welcome, <strong>{{ user.username }}</strong>! Here is an overview of
        the system.
      </p>
    </div>
  </div>

  <!-- Blood Requests Section -->
  <div class="card mb-5 shadow-lg border-light">
    <div
      class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
    >
      <h4 class="mb-0">Blood Requests</h4>
      <i class="bi bi-clipboard-plus"></i>
    </div>
    <div class="card-body">
      {% if blood_requests %}
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Blood Group</th>
              <th>City</th>
              <th>Contact</th>
              <th>Address</th>
              <th>D.O.B.</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for request in blood_requests %}
            <tr>
              <td>{{ request.full_name }}</td>
              <td>
                <span class="badge bg-danger">{{ request.blood_group }}</span>
              </td>
              <td>{{ request.city }}</td>
              <td>{{ request.contact_number }}</td>
              <td>{{ request.address|truncatechars:20 }}</td>
              <td>{{ request.date_of_birth }}</td>
              <td>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-success btn-sm approve-btn" data-id="{{ request.id }}">
                    <i class="bi bi-check-circle"></i> Approve
                  </button>
                  <a
                    href="{% url 'delete_request' request.id %}"
                    class="btn btn-outline-danger btn-sm"
                    onclick="return confirm('Are you sure you want to delete this request?');"
                  >
                    <i class="bi bi-trash"></i> Delete
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">No blood requests found.</div>
      {% endif %}
    </div>
  </div>

</div>

 <!-- Registered Donors Section -->
 <div class="card mb-5 shadow-lg border-light">
  <div
    class="card-header bg-success text-white d-flex justify-content-between align-items-center"
  >
    <h4 class="mb-0">Registered Donors</h4>
    <i class="bi bi-person-plus"></i>
  </div>
  <div class="card-body">
    {% if donors %}
    <div class="table-responsive">
      <table class="table table-hover table-bordered">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Blood Group</th>
            <th>City</th>
            <th>Email</th>

            <th>Contact</th>
            <th>Address</th>
            <th>D.O.B.</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for donor in donors %}
          <tr>
            <td>{{ donor.first_name }} {{ donor.last_name }}</td>
            <td>
              <span class="badge bg-danger">{{ donor.blood_group }}</span>
            </td>
            <td>{{ donor.city }}</td>
            <td>{{ donor.email }}</td>
            
            <td>{{ donor.contact_number }}</td>
            <td>{{ donor.address|truncatechars:20 }}</td>
            <td>{{ donor.date_of_birth }}</td>
            <td>
              <a
                href="{% url 'delete_donor' donor.id %}"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Are you sure you want to delete this donor?');"
              >
                <i class="bi bi-trash"></i> Delete
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">No donors found.</div>
    {% endif %}
  </div>
</div>

<!-- Feedback Section -->
<div class="card mb-5 shadow-lg border-light">
  <div
    class="card-header bg-warning text-white d-flex justify-content-between align-items-center"
  >
    <h4 class="mb-0">Feedback</h4>
    <i class="bi bi-pencil-square"></i>
  </div>
  <div class="card-body">
    {% if feedbacks %}
    <div class="table-responsive">
      <table class="table table-hover table-bordered">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Rating</th>
            <th>Message</th>
            <th>Submitted At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for feedback in feedbacks %}
          <tr>
            <td>{{ feedback.name }}</td>
            <td>{{ feedback.email }}</td>
            <td>{{ feedback.rating }}</td>
            <td>{{ feedback.message|truncatechars:50 }}</td>
            <td>{{ feedback.submitted_at }}</td>
            <td>
              <a
                href="{% url 'delete_feedback' feedback.id %}"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Are you sure you want to delete this feedback?');"
              >
                <i class="bi bi-trash"></i> Delete
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">No feedback found.</div>
    {% endif %}
  </div>
</div>

<!-- Contact Us Section -->
<div class="card shadow-lg border-light">
  <div
    class="card-header bg-info text-white d-flex justify-content-between align-items-center"
  >
    <h4 class="mb-0">Contact Us Entries</h4>
    <i class="bi bi-envelope-open"></i>
  </div>
  <div class="card-body">
    {% if contact_us_entries %}
    <div class="table-responsive">
      <table class="table table-hover table-bordered">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Message</th>
            <th>Submitted At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for contact in contact_us_entries %}
          <tr>
            <td>{{ contact.name }}</td>
            <td>{{ contact.email }}</td>
            <td>{{ contact.message|truncatechars:50 }}</td>
            <td>{{ contact.submitted_at }}</td>
            <td>
              <a
                href="{% url 'delete_contact_us' contact.id %}"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Are you sure you want to delete this contact entry?');"
              >
                <i class="bi bi-trash"></i> Delete
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">No contact entries found.</div>
    {% endif %}
  </div>
</div>
</div>

<!-- Modal for Matched Donors -->
<!-- Modal for Matched Donors -->
<div class="modal fade" id="donorModal" tabindex="-1" aria-labelledby="donorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="donorModalLabel">Matched Donors</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="donorList" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <!-- The Notify button will trigger the email send -->
        <button id="notifyBtn" type="button" class="btn btn-primary">Notify Donor</button>
      </div>
    </div>
  </div>
</div>


<script>
  // Handle form submission and display the modal with matched donors
document.querySelectorAll('.approve-btn').forEach(button => {
  button.addEventListener('click', function (event) {
    const requestId = button.getAttribute('data-id');

    // Send AJAX request to approve the request and get matched donors
    fetch(`/approve_request/${requestId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ request_id: requestId }),
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Network response was not ok.");
      }
      return response.json();
    })
    .then(data => {
      if (data.status === "success") {
        const donorList = document.getElementById('donorList');
        donorList.innerHTML = '';  // Clear the previous donor list

        data.matched_donors.forEach(donor => {
          const listItem = document.createElement('li');
          listItem.classList.add('list-group-item');
          listItem.textContent = `${donor.name} (${donor.blood_group}) - ${donor.city}`;
          
          // Add a Notify button for each donor
          const notifyButton = document.createElement('button');
          notifyButton.classList.add('btn', 'btn-sm', 'btn-primary', 'ml-2');
          notifyButton.textContent = 'Notify';
          
          // Attach an event listener to the Notify button
          notifyButton.addEventListener('click', function () {
            // Send the notification to the donor (AJAX)
            notifyDonor(donor.id, requestId);
          });

          listItem.appendChild(notifyButton);
          donorList.appendChild(listItem);
        });

        // Show the modal with matched donors
        const modal = new bootstrap.Modal(document.getElementById('donorModal'));
        modal.show();
      } else {
        alert("Something went wrong. Please try again.");
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("An error occurred while processing your request.");
    });
  });
});

// Function to notify donor
function notifyDonor(donorId, requestId) {
  fetch(`/approve_donor_for_request/${donorId}/${requestId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}",
    }
  })
  .then(response => {
    if (response.ok) {
      alert('Notification sent to the donor.');
    } else {
      alert('Failed to send notification.');
    }
  })
  .catch(error => {
    console.error("Error:", error);
    alert('An error occurred while sending the notification.');
  });
}

</script>
{% endblock %}
